<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chat de Tesis</title>
    <style>
      :root {
        color-scheme: dark;
        font-family: "Inter", system-ui, -apple-system, "Segoe UI", sans-serif;
        --bg: #070c10;
        --surface: #0d141a;
        --surface-2: #111a21;
        --surface-3: #141f28;
        --surface-4: #1b2a36;
        --border: #1c2a35;
        --primary: #1f9cf0;
        --primary-soft: rgba(31, 156, 240, 0.12);
        --text: #e8eef2;
        --muted: #8ca0b4;
        --danger: #f87171;
      }

      * {
        box-sizing: border-box;
      }

      body {
        background: var(--bg);
        color: var(--text);
        margin: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header {
        backdrop-filter: blur(16px);
        background: rgba(7, 12, 16, 0.85);
        border-bottom: 1px solid var(--border);
        position: sticky;
        top: 0;
        z-index: 20;
      }

      .topbar {
        max-width: 1200px;
        margin: 0 auto;
        padding: 18px 24px;
        display: flex;
        align-items: center;
        gap: 32px;
      }

      .brand {
        font-weight: 600;
        font-size: 18px;
      }

      nav {
        display: flex;
        gap: 18px;
        flex: 1;
      }

      nav a {
        color: var(--muted);
        text-decoration: none;
        font-weight: 500;
        padding-bottom: 4px;
      }

      nav a.active,
      nav a:hover {
        color: var(--text);
        border-bottom: 2px solid var(--primary);
      }

      .avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--surface-4);
        color: var(--primary);
        font-weight: 600;
        display: grid;
        place-items: center;
      }

      main {
        flex: 1;
        display: grid;
        grid-template-columns: 280px 1fr 280px;
        gap: 20px;
        max-width: 1200px;
        margin: 32px auto;
        padding: 0 24px 32px;
      }

      .card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 18px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        min-height: 0;
      }

      .card-header {
        padding: 20px 20px 16px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .card-header h2 {
        margin: 0;
        font-size: 18px;
      }

      .sidebar-content {
        overflow-y: auto;
        padding: 12px 0;
      }

      .conversation {
        padding: 12px 18px;
        display: grid;
        gap: 4px;
        border-left: 3px solid transparent;
        cursor: pointer;
      }

      .conversation:hover {
        background: rgba(31, 156, 240, 0.08);
      }

      .conversation.active {
        border-color: var(--primary);
        background: rgba(31, 156, 240, 0.12);
      }

      .conversation-title {
        font-size: 15px;
        font-weight: 600;
      }

      .conversation-meta {
        font-size: 12px;
        color: var(--muted);
      }

      .chat-area {
        display: grid;
        grid-template-rows: auto 1fr auto;
        height: 100%;
      }

      .chat-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--border);
      }

      .chat-header h1 {
        font-size: 20px;
        margin: 0 0 4px;
      }

      .chat-header p {
        margin: 0;
        color: var(--muted);
        font-size: 13px;
      }

      .messages {
        padding: 24px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 12px;
        background: var(--surface-2);
      }

      .bubble {
        max-width: 80%;
        padding: 14px 16px;
        border-radius: 18px;
        position: relative;
        font-size: 14px;
        line-height: 1.5;
        white-space: pre-wrap;
      }

      .bubble.user {
        margin-left: auto;
        border-bottom-right-radius: 6px;
        background: var(--primary);
        color: #061623;
      }

      .bubble.bot {
        margin-right: auto;
        border-bottom-left-radius: 6px;
        background: var(--surface-3);
      }

      .bubble.system {
        margin: 0 auto;
        background: rgba(148, 163, 184, 0.16);
        border: 1px dashed rgba(148, 163, 184, 0.25);
        color: var(--muted);
        font-size: 12px;
      }

      .bubble small {
        display: block;
        margin-top: 6px;
        font-size: 11px;
        color: rgba(6, 22, 35, 0.7);
      }

      .bubble.bot small {
        color: rgba(200, 215, 230, 0.6);
      }

      form.send-message {
        padding: 18px 20px;
        background: var(--surface);
        border-top: 1px solid var(--border);
        display: flex;
        gap: 12px;
      }

      form.send-message textarea {
        flex: 1;
        resize: none;
        min-height: 48px;
        max-height: 140px;
        padding: 12px 14px;
        border-radius: 14px;
        border: 1px solid var(--border);
        background: var(--surface-3);
        color: var(--text);
        font-size: 14px;
        line-height: 1.5;
      }

      form.send-message button {
        padding: 0 18px;
        border-radius: 14px;
        background: var(--primary);
        color: #041321;
        border: none;
        font-weight: 600;
        cursor: pointer;
        display: grid;
        place-items: center;
        min-width: 120px;
      }

      form.send-message button[disabled] {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .context-panel {
        padding-bottom: 16px;
      }

      .context-panel h3 {
        margin: 0 0 6px;
        font-size: 16px;
      }

      .context-panel p,
      .context-panel li {
        color: var(--muted);
        font-size: 13px;
        line-height: 1.6;
      }

      .context-panel ul {
        margin: 0;
        padding-left: 20px;
        display: grid;
        gap: 6px;
      }

      .quick-actions {
        display: grid;
        gap: 10px;
        margin-top: 12px;
      }

      .quick-actions button {
        border-radius: 12px;
        padding: 12px 14px;
        border: 1px solid var(--border);
        background: var(--surface-2);
        color: var(--text);
        font-size: 13px;
        text-align: left;
        cursor: pointer;
      }

      .empty-state {
        flex: 1;
        display: grid;
        place-items: center;
        color: var(--muted);
        text-align: center;
        padding: 24px;
      }

      .tag {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid var(--border);
        font-size: 11px;
        color: var(--muted);
        margin-top: 6px;
      }

      .chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 10px;
        border-radius: 999px;
        background: rgba(148, 163, 184, 0.14);
        color: var(--muted);
        font-size: 12px;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--primary);
      }

      .toolbar {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .toolbar input {
        flex: 1;
        border-radius: 12px;
        border: 1px solid var(--border);
        padding: 10px 12px;
        background: var(--surface-2);
        color: var(--text);
      }

      .toolbar button {
        background: var(--primary);
        color: #041321;
        border: none;
        padding: 10px 14px;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
      }

      @media (max-width: 1100px) {
        main {
          grid-template-columns: 260px 1fr;
        }
        .context-panel {
          display: none;
        }
      }

      @media (max-width: 820px) {
        nav {
          display: none;
        }
        main {
          grid-template-columns: 1fr;
        }
        .sidebar {
          order: 2;
        }
        .chat-area {
          order: 1;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="topbar">
        <div class="brand">TECSUP</div>
        <nav>
          <a href="/profile">Inicio</a>
          <a href="/chat" class="active">Chat</a>
          <a href="/settings">Mi cuenta</a>
        </nav>
        <div class="avatar" id="userAvatar">--</div>
      </div>
    </header>

    <main>
      <section class="card sidebar">
        <div class="card-header">
          <h2>Mis conversaciones</h2>
          <div class="toolbar">
            <input id="conversationFilter" placeholder="Buscar" />
            <button id="createConversation" title="Nueva conversación">＋</button>
          </div>
        </div>
        <div class="sidebar-content" id="conversationList"></div>
      </section>

      <section class="card chat-area">
        <div class="chat-header">
          <h1 id="conversationTitle">Selecciona una conversación</h1>
          <p id="conversationMeta">Consulta tus conversaciones para continuar.</p>
        </div>
        <div class="messages" id="messagesPanel">
          <div class="empty-state" id="emptyMessages">
            <p>Selecciona o crea una conversación para empezar a chatear.</p>
          </div>
        </div>
        <form class="send-message" id="messageForm">
          <textarea
            id="messageInput"
            rows="2"
            placeholder="Escribe tu pregunta sobre tesis..."
            disabled
          ></textarea>
          <button type="submit" id="sendButton" disabled>Enviar</button>
        </form>
      </section>

      <aside class="card context-panel">
        <div class="card-header">
          <h2>Recomendaciones</h2>
        </div>
        <div style="padding: 18px 20px 24px; display: grid; gap: 18px;">
          <div>
            <h3>¿Cómo puedo ayudarte?</h3>
            <p>
              Puedes preguntar sobre temas de tesis, metodologías, estructuras o tendencias.
              Aquí tienes algunas ideas para comenzar.
            </p>
            <div class="quick-actions">
              <button data-quick="Necesito ideas para una tesis sobre energías renovables">
                Ideas sobre energías renovables
              </button>
              <button data-quick="¿Qué metodología recomiendas para una tesis de automatización industrial?">
                Metodologías recomendadas
              </button>
              <button data-quick="Resúmeme los puntos clave de la tesis sobre desarrollo de software ágil">
                Resumen de tesis destacadas
              </button>
            </div>
          </div>
          <div>
            <h3>Tesis relacionadas</h3>
            <ul id="relatedList">
              <li>Consulta reciente: <span class="tag">Sin datos</span></li>
            </ul>
          </div>
        </div>
      </aside>
    </main>

    <script>
      const state = {
        conversations: [],
        filtered: [],
        selectedConversation: null,
        messages: [],
        user: null,
        loadingMessages: false,
      };

      const conversationListEl = document.getElementById("conversationList");
      const messagesPanelEl = document.getElementById("messagesPanel");
      const emptyMessagesEl = document.getElementById("emptyMessages");
      const conversationTitleEl = document.getElementById("conversationTitle");
      const conversationMetaEl = document.getElementById("conversationMeta");
      const messageInputEl = document.getElementById("messageInput");
      const sendButtonEl = document.getElementById("sendButton");
      const messageFormEl = document.getElementById("messageForm");
      const filterEl = document.getElementById("conversationFilter");
      const avatarEl = document.getElementById("userAvatar");
      const relatedListEl = document.getElementById("relatedList");

      async function fetchJSON(url, options) {
        const response = await fetch(url, options);
        if (!response.ok) {
          throw new Error(`Error ${response.status}`);
        }
        return response.json();
      }

      function initialsFromName(name) {
        if (!name) return "--";
        const parts = name.trim().split(/\s+/).slice(0, 2);
        return parts.map((p) => p[0]?.toUpperCase() || "").join("") || "--";
      }

      function formatDate(value) {
        if (!value) return "";
        try {
          const date = new Date(value);
          return date.toLocaleString("es-PE", {
            day: "2-digit",
            month: "short",
            hour: "2-digit",
            minute: "2-digit",
          });
        } catch (err) {
          return String(value);
        }
      }

      function renderAvatar() {
        if (!state.user) return;
        avatarEl.textContent = initialsFromName(state.user.display_name || state.user.email);
      }

      function renderConversations() {
        const list = filterEl.value
          ? state.conversations.filter((item) =>
              (item.title || "").toLowerCase().includes(filterEl.value.toLowerCase())
            )
          : state.conversations;

        if (!list.length) {
          conversationListEl.innerHTML = `
            <div class="empty-state" style="padding: 48px 16px;">
              <p>No tienes conversaciones aún. ¡Crea una nueva!</p>
            </div>`;
          return;
        }

        conversationListEl.innerHTML = list
          .map((conv) => {
            const isActive = state.selectedConversation?.id === conv.id;
            const lastMessageAt = conv.last_message_at || conv.created_at;
            const participants = Array.isArray(conv.participants)
              ? conv.participants.length
              : conv.participants_count || 1;
            return `
              <article class="conversation ${isActive ? "active" : ""}" data-id="${conv.id}">
                <div class="conversation-title">${conv.title || "Conversación sin título"}</div>
                <div class="conversation-meta">
                  ${participants} participante${participants === 1 ? "" : "s"} · ${
              conv.messages_count || 0
            } mensajes
                </div>
                <div class="conversation-meta">Última actividad: ${formatDate(lastMessageAt)}</div>
              </article>`;
          })
          .join("");
      }

      function renderMessages() {
        if (!state.selectedConversation) {
          emptyMessagesEl.style.display = "grid";
          messagesPanelEl.querySelectorAll(".bubble").forEach((el) => el.remove());
          return;
        }

        emptyMessagesEl.style.display = state.messages.length ? "none" : "grid";

        const existing = new Set();
        messagesPanelEl.querySelectorAll(".bubble").forEach((el) => {
          existing.add(el.dataset.id);
        });

        const fragment = document.createDocumentFragment();
        state.messages.forEach((msg) => {
          if (existing.has(String(msg.id))) return;
          const bubble = document.createElement("div");
          bubble.className = `bubble ${msg.sender || "system"}`;
          bubble.dataset.id = msg.id;
          bubble.innerHTML = `
            <div>${(msg.content || "").replace(/</g, "&lt;")}</div>
            <small>${msg.sender === "user" ? "Tú" : msg.sender === "bot" ? "Asistente" : "Sistema"} · ${formatDate(msg.created_at)}</small>
          `;
          fragment.appendChild(bubble);
        });

        if (fragment.childNodes.length) {
          emptyMessagesEl.after(fragment);
          messagesPanelEl.scrollTop = messagesPanelEl.scrollHeight;
        }
      }

      async function loadSession() {
        try {
          const res = await fetchJSON("/me");
          if (res.user) {
            state.user = res.user;
            renderAvatar();
          }
        } catch (err) {
          console.error("No se pudo obtener la sesión", err);
        }
      }

      async function loadConversations() {
        try {
          const res = await fetchJSON("/api/chat/conversations");
          state.conversations = Array.isArray(res.data) ? res.data : [];
          renderConversations();
          if (state.conversations.length && !state.selectedConversation) {
            selectConversation(state.conversations[0].id);
          }
        } catch (err) {
          console.error("Error al cargar conversaciones", err);
          conversationListEl.innerHTML = `
            <div class="empty-state" style="padding: 48px 16px; color: var(--danger);">
              <p>No fue posible cargar las conversaciones.</p>
            </div>`;
        }
      }

      async function selectConversation(conversationId) {
        if (!conversationId || state.loadingMessages) return;
        const conversation = state.conversations.find((c) => String(c.id) === String(conversationId));
        if (!conversation) return;

        state.selectedConversation = conversation;
        conversationTitleEl.textContent = conversation.title || "Conversación sin título";
        const participants = Array.isArray(conversation.participants)
          ? conversation.participants.length
          : conversation.participants_count || 1;
        conversationMetaEl.textContent = `Participantes: ${participants} · Mensajes: ${
          conversation.messages_count || 0
        }`;
        messageInputEl.disabled = false;
        sendButtonEl.disabled = false;
        renderConversations();
        await loadMessages(conversation.id);
        updateRelated(conversation);
      }

      async function loadMessages(conversationId) {
        state.loadingMessages = true;
        try {
          const res = await fetchJSON(`/api/chat/conversations/${conversationId}/messages`);
          state.messages = Array.isArray(res.data) ? res.data : [];
          renderMessages();
        } catch (err) {
          console.error("Error al obtener mensajes", err);
          emptyMessagesEl.style.display = "grid";
          emptyMessagesEl.innerHTML = `<p style="color: var(--danger);">No fue posible cargar los mensajes.</p>`;
        } finally {
          state.loadingMessages = false;
        }
      }

      async function handleSendMessage(event) {
        event.preventDefault();
        if (!state.selectedConversation) return;
        const content = messageInputEl.value.trim();
        if (!content) return;

        sendButtonEl.disabled = true;
        sendButtonEl.textContent = "Enviando...";

        try {
          const res = await fetchJSON(`/api/chat/conversations/${state.selectedConversation.id}/messages`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ content }),
          });
          messageInputEl.value = "";
          if (res.data) {
            state.messages.push(res.data);
            state.selectedConversation.messages_count =
              (state.selectedConversation.messages_count || 0) + 1;
            renderMessages();
            renderConversations();
          }
        } catch (err) {
          console.error("No se pudo enviar el mensaje", err);
          alert("Hubo un problema al enviar el mensaje. Inténtalo nuevamente.");
        } finally {
          sendButtonEl.disabled = false;
          sendButtonEl.textContent = "Enviar";
          messageInputEl.focus();
        }
      }

      async function createConversation() {
        const title = prompt("¿Cómo deseas llamar a la conversación?") || "Consulta de tesis";
        try {
          const res = await fetchJSON("/api/chat/conversations", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ title }),
          });
          if (res.data) {
            state.conversations.unshift(res.data);
            renderConversations();
            selectConversation(res.data.id);
          }
        } catch (err) {
          console.error("No se pudo crear la conversación", err);
          alert("No fue posible crear la conversación. Intenta más tarde.");
        }
      }

      function updateRelated(conversation) {
        const related = [];
        if (conversation?.title) related.push({ label: "Tema", value: conversation.title });
        if (conversation?.messages_count) {
          related.push({ label: "Mensajes", value: conversation.messages_count });
        }
        if (Array.isArray(conversation?.participants)) {
          related.push({ label: "Participantes", value: conversation.participants.length });
        }
        if (!related.length) {
          relatedListEl.innerHTML = `<li>Consulta reciente: <span class="tag">Sin datos</span></li>`;
          return;
        }
        relatedListEl.innerHTML = related
          .map(
            (item) => `
            <li>
              ${item.label}: <span class="chip"><span class="status-dot"></span> ${item.value}</span>
            </li>`
          )
          .join("");
      }

      conversationListEl.addEventListener("click", (event) => {
        const article = event.target.closest(".conversation");
        if (!article) return;
        selectConversation(article.dataset.id);
      });

      messageFormEl.addEventListener("submit", handleSendMessage);
      document.getElementById("createConversation").addEventListener("click", createConversation);
      filterEl.addEventListener("input", renderConversations);

      document.querySelectorAll("[data-quick]").forEach((button) => {
        button.addEventListener("click", () => {
          const value = button.getAttribute("data-quick");
          messageInputEl.value = value;
          messageInputEl.focus();
        });
      });

      loadSession();
      loadConversations();
    </script>
  </body>
</html>