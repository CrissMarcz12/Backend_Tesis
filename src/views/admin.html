<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Panel de Administración</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
       :root {
        color-scheme: dark;
        font-family: "Inter", system-ui, -apple-system, "Segoe UI", sans-serif;
        --bg: #070c10;
        --surface: #0e151c;
        --surface-2: #121c25;
        --surface-3: #172330;
        --border: #1c2c3b;
        --primary: #1f9cf0;
        --muted: #92a6b8;
        --text: #e8eef2;
        --danger: #f87171;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
         min-height: 100vh;
        background: radial-gradient(circle at top left, rgba(31, 156, 240, 0.08), transparent 45%),
          var(--bg);
        color: var(--text);
        display: flex;
        flex-direction: column;
      }

      header {
        backdrop-filter: blur(16px);
        background: rgba(8, 13, 18, 0.85);
         border-bottom: 1px solid rgba(28, 44, 59, 0.75);
        position: sticky;
        top: 0;
        z-index: 10;
      }
      .topbar {
        max-width: 1200px;
        margin: 0 auto;
        padding: 18px 24px;
        display: flex;
        gap: 28px;
        align-items: center;
      }
      .brand {
        font-weight: 700;
        letter-spacing: 0.04em;
      }
      nav {
        display: flex;
        gap: 18px;
        flex: 1;
      }
      nav a {
        color: var(--muted);
        text-decoration: none;
        font-weight: 500;
        padding-bottom: 4px;
      }
      nav a.active,
      nav a:hover {
        color: var(--text);
        border-bottom: 2px solid var(--primary);
      }
      .avatar {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        background: rgba(31, 156, 240, 0.12);
        display: grid;
        place-items: center;
                color: var(--primary);
        font-weight: 600;
        font-size: 14px;
        color: #1f9cf0;
      }
       main {
        flex: 1;
        width: min(1200px, 100%);
        margin: 32px auto;
        padding: 0 24px 32px;
        display: grid;
        gap: 28px;
      }
      h1 {
        margin-bottom: 28px;
        font-size: 32px;
        font-weight: 700;
      }
            p.subtitle {
        margin: 6px 0 0;
        color: var(--muted);
      }
  .stats-grid {
        display: grid;
        gap: 18px;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }

      .stat-card {
        border-radius: 18px;
        padding: 20px 22px;
        background: linear-gradient(145deg, rgba(17, 28, 40, 0.92), rgba(11, 20, 27, 0.85));
        border: 1px solid rgba(31, 156, 240, 0.18);
        display: grid;
        gap: 8px;
      }

      .stat-card h3 {
        margin: 0;
        color: var(--muted);
        font-size: 13px;
        letter-spacing: 0.04em;
        text-transform: uppercase;
      }

      .stat-card .value {
        font-size: clamp(26px, 4vw, 34px);
        font-weight: 700;
      }

      .stat-card .trend {
        font-size: 12px;
        color: #22d3ee;
      }

      section.card {
        background: rgba(12, 19, 27, 0.92);
        border-radius: 22px;
        border: 1px solid rgba(28, 44, 59, 0.8);
        padding: 24px 26px;
        display: grid;
        gap: 20px;
      }

      section.card header {
        position: static;
        backdrop-filter: none;
        background: transparent;
        border-bottom: none;
        padding: 0;
      }

      section.card header h2 {
        margin: 0;
        font-size: 20px;
      }

      .suggestions {
        display: grid;
        gap: 16px;
      }

      .suggestion {
        background: rgba(22, 34, 45, 0.75);
        border: 1px solid rgba(45, 65, 86, 0.4);
        border-radius: 16px;
        padding: 16px 18px;
        display: grid;
        gap: 8px;
      }
 .suggestion header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;}
      
      .suggestion strong {
        font-size: 15px;
      }
      .suggestion p {
        margin: 0;
        font-size: 14px;
        color: var(--muted);
      }
        .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        background: rgba(31, 156, 240, 0.12);
        color: var(--primary);
        font-size: 12px;
      }

      .table-wrapper {
        overflow-x: auto;
        border-radius: 16px;
        border: 1px solid rgba(36, 52, 67, 0.6);
        background: rgba(14, 23, 31, 0.9);
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 16px 18px;
        border-bottom: 1px solid rgba(32, 46, 60, 0.6);
        text-align: left;
      }
      th {
        color: var(--muted);
        font-weight: 600;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.04em;
      }
   tbody tr:hover {
        background: rgba(31, 156, 240, 0.08);
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;

        font-size: 12px;
        background: rgba(148, 163, 184, 0.12);
        color: var(--muted);
      }
      .grid-2 {
        display: grid;
        gap: 20px;
        grid-template-columns: 1.2fr 1fr;
      }

      @media (max-width: 1024px) {
        .grid-2 {
          grid-template-columns: 1fr;
        }
      }
      @media (max-width: 720px) {
        nav {
          display: none;
        }

        main {
          padding: 0 18px 32px;
        }
      }
    </style>
  </head>
  <body>
        <header>
      <div class="topbar">
        <div class="brand">Tecsup</div>
        <nav>
          <a href="/admin" class="active">Resumen</a>
          <a href="/admin/manage">Usuarios</a>
          <a href="/admin/chat">Chat</a>
        </nav>
                <div class="avatar" id="adminAvatar">AD</div>
      </div>
    </header>
    <div>
          <main>
      <div>
        <h1>Panel de Administración</h1>
        <p class="subtitle">Monitorea el rendimiento del asistente y las conversaciones en tiempo real.</p>
    </div>

<div class="stats-grid" id="statsGrid"></div>
            <div class="grid-2">
        <section class="card" aria-labelledby="suggestions-title">
          <header>
            <h2 id="suggestions-title">Sugerencias de mejora</h2>
            <p style="margin: 6px 0 0; color: var(--muted);">
              Valoraciones y comentarios recientes de los usuarios.
            </p>
          </header>
          <div class="suggestions" id="suggestionsList"></div>
        </section>

       <section class="card" aria-labelledby="feedback-title">
          <header>
            <h2 id="feedback-title">Usuarios más activos</h2>
            <p style="margin: 6px 0 0; color: var(--muted);">
              Promedio de satisfacción según las calificaciones enviadas.
            </p>
          </header>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Usuario</th>
                  <th>Calificaciones</th>
                  <th>Promedio</th>
                </tr>
              </thead>
              <tbody id="feedbackSummaryBody"></tbody>
            </table>
          </div>
        </section>
      </div>

  <section class="card" aria-labelledby="conversations-title">
        <header>
          <div style="display: flex; justify-content: space-between; align-items: center; gap: 16px;">
            <div>
              <h2 id="conversations-title">Consultas recientes</h2>
              <p style="margin: 6px 0 0; color: var(--muted);">
                Seguimiento de las conversaciones más activas del asistente.
              </p>
            </div>
            <a href="/admin/chat" class="badge">Ver panel completo</a>
          </div>
        </header>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Conversación</th>
                <th>Propietario</th>
                <th>Mensajes</th>
                <th>Última actividad</th>
                <th>Feedback</th>
              </tr>
            </thead>
            <tbody id="conversationsTable"></tbody>
          </table>
        </div>
      </section>
    </main>

    <script>
      const statsGrid = document.getElementById("statsGrid");
      const suggestionsList = document.getElementById("suggestionsList");
      const feedbackBody = document.getElementById("feedbackSummaryBody");
      const conversationsTable = document.getElementById("conversationsTable");
      const avatarEl = document.getElementById("adminAvatar");

      const state = {
        stats: {
          conversations: 0,
          messages: 0,
          activeUsers: 0,
          feedback: 0,
        },
        suggestions: [],
        feedbackSummary: [],
        conversations: [],
        conversationsTotal: 0,
        user: null,
      };
      function initialsFromName(name) {
        if (!name) return "AD";
        const parts = name.trim().split(/\s+/).slice(0, 2);
        const initials = parts.map((part) => part.charAt(0).toUpperCase()).join("");
        return initials || "AD";
      }


      function formatDate(date) {
        if (!date) return "--";
        const d = new Date(date);
        return d.toLocaleString("es-PE", {
          day: "2-digit",
          month: "short",
          hour: "2-digit",
          minute: "2-digit", });

function renderStats() {
        const items = [
          {
            label: "Consultas Totales",
            value: state.stats.conversations,
            hint: `${state.stats.messages} mensajes registrados`,
          },
          {
            label: "Usuarios Activos",
            value: state.stats.activeUsers,
            hint: `Feedback recibido: ${state.stats.feedback}`,
          },
          {
            label: "Tasa de Respuesta",
            value: state.stats.conversations ? `${Math.min(99, Math.round((state.stats.messages / (state.stats.conversations * 4)) * 100))}%` : "--",
            hint: "Promedio estimado de interacción",
          },
          {
            label: "Conversaciones Recientes",
            value: state.conversations.length,
            hint: `Mostrando ${state.conversations.length} de ${state.stats.conversations}`,
          },
        ];

        statsGrid.innerHTML = items
          .map(
            (item) => `
            <article class="stat-card">
              <h3>${item.label}</h3>
              <div class="value">${typeof item.value === "number" ? item.value.toLocaleString("es-PE") : item.value}</div>
              <div class="trend">${item.hint}</div>
            </article>`
          )
          .join("");
      }

      function renderSuggestions() {
        if (!state.suggestions.length) {
          suggestionsList.innerHTML = `
            <div style="padding: 24px; background: rgba(25, 37, 47, 0.6); border-radius: 16px; color: var(--muted);">
              No hay sugerencias disponibles por el momento.
            </div>`;
          return;
        }
        
  suggestionsList.innerHTML = state.suggestions
          .map((item) => {
            const rating = "★".repeat(item.rating || 0).padEnd(5, "☆");
            return `
              <article class="suggestion">
                <header>
                  <strong>${item.user_display_name || item.user_email || "Usuario"}</strong>
                  <span>${rating}</span>
                </header>
                <p style="margin: 0; color: var(--muted);">${item.comment || "Sin comentarios"}</p>
                <span>${formatDate(item.created_at)}</span>
              </article>`;
          })
          .join("");
      }


            function renderFeedbackSummary() {
        if (!state.feedbackSummary.length) {
          feedbackBody.innerHTML = `
            <tr>
              <td colspan="3" style="text-align: center; padding: 28px; color: var(--muted);">
                Aún no se registran calificaciones.
              </td>
            </tr>`;
          return;
        } };
  feedbackBody.innerHTML = state.feedbackSummary
          .map(
            (item) => `
            <tr>
              <td>${item.user_display_name || item.user_email || "Usuario"}</td>
              <td>${item.total_ratings || 0}</td>
              <td>${item.avg_rating ? Number(item.avg_rating).toFixed(2) : "--"}</td>
            </tr>`
          )
          .join("");
      }

      function renderConversations() {
        if (!state.conversations.length) {
          conversationsTable.innerHTML = `
            <tr>
              <td colspan="5" style="text-align:center; padding: 28px; color: var(--muted);">
                No se encontraron conversaciones recientes.
              </td>
            </tr>`;
          return;
        }
      };

 conversationsTable.innerHTML = state.conversations
          .map((conv) => {
            const feedbackBadge = conv.total_feedback
              ? `<span class="pill">${conv.avg_feedback_rating ? Number(conv.avg_feedback_rating).toFixed(1) : "--"} ★ · ${conv.total_feedback}</span>`
              : "<span class=\"pill\">Sin feedback</span>";
            return `
              <tr>
                <td>${conv.title || "Sin título"}</td>
                <td>${conv.owner_display_name || conv.owner_email || "--"}</td>
                <td>${conv.messages_count || 0}</td>
                <td>${formatDate(conv.last_message_at || conv.created_at)}</td>
                <td>${feedbackBadge}</td>
              </tr>`;
          })
          .join("");
      

      function computeStats() {
        const conversationSet = new Set();
        const userSet = new Set();
        let messageCounter = 0;
        let feedbackCounter = 0;

        state.conversations.forEach((conv) => {
          conversationSet.add(conv.id);
          messageCounter += Number(conv.messages_count) || 0;
          if (conv.owner_user_id) userSet.add(conv.owner_user_id);
          if (Array.isArray(conv.participants)) {
            conv.participants.forEach((p) => userSet.add(p.user_id || p));
          }
          feedbackCounter += Number(conv.total_feedback) || 0;
        });

  let summaryTotal = 0;
        state.feedbackSummary.forEach((item) => {
          if (item.user_id) userSet.add(item.user_id);
          summaryTotal += Number(item.total_ratings) || 0;
        });

        if (summaryTotal) {
          feedbackCounter = summaryTotal;

        }
        load();
                state.stats.conversations = state.conversationsTotal || conversationSet.size;
        state.stats.messages = messageCounter;
        state.stats.activeUsers = userSet.size;
        state.stats.feedback = feedbackCounter;
      
      }
        async function loadDashboard() {
        try {
          const [sessionRes, convRes, feedbackSummaryRes, feedbackMessagesRes] = await Promise.all([
            fetch("/me").then((r) => r.json()).catch(() => ({})),
            fetch("/api/admin/chat/conversations?limit=10").then((r) => r.json()).catch(() => ({})),
            fetch("/api/admin/chat/feedback/summary").then((r) => r.json()).catch(() => ({})),
            fetch("/api/admin/chat/feedback/messages?limit=5").then((r) => r.json()).catch(() => ({})),
          ]);

          state.user = sessionRes?.user || null;
          if (state.user) avatarEl.textContent = initialsFromName(state.user.display_name || state.user.email);

          state.conversations = Array.isArray(convRes?.data) ? convRes.data : [];
          state.conversationsTotal = Number(convRes?.total) || state.conversations.length;
          state.feedbackSummary = Array.isArray(feedbackSummaryRes?.data) ? feedbackSummaryRes.data : [];
          state.suggestions = Array.isArray(feedbackMessagesRes?.data) ? feedbackMessagesRes.data : [];

          computeStats();
          renderStats();
          renderSuggestions();
          renderFeedbackSummary();
          renderConversations();
        } catch (err) {
          console.error("No se pudo cargar el panel", err);
          statsGrid.innerHTML = `<div style="padding:24px; border-radius:16px; background:rgba(24,34,44,0.8); color: var(--danger);">Ocurrió un error al cargar la información.</div>`;
        }
      }

      loadDashboard();
    </script>
  </body>
</html>
